<ion-content class="bg-gray-50/30">
    <div class="max-w-2xl mx-auto px-6 py-8">

        <!-- Header -->
        <header class="mb-10 mt-10 text-center md:text-left transition-all">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight mb-2">
                {{ selectedElection() ? selectedElection()?.name : 'Secure Voting Portal' }}
            </h1>
            <p class="text-sm text-gray-400 font-medium leading-relaxed">
                {{ selectedElection() ? 'Select your preferred candidate for this position.' : 'Browse the categories
                below and select your candidates for each election.' }}
            </p>
        </header>

        <!-- Step 1: Election Categories -->
        <div *ngIf="!selectedElection()" class="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div *ngFor="let election of elections()" (click)="selectElection(election)"
                class="group relative flex items-center justify-between p-5 rounded-2xl border-2 transition-all duration-300 cursor-pointer overflow-hidden"
                [ngClass]="hasSelectionsForElection(election.id) ? 'border-blue-500 bg-blue-50/10' : 'border-gray-100 bg-white hover:border-blue-200 hover:shadow-md'">

                <div class="flex items-center gap-4">
                    <div class="p-3 rounded-xl transition-colors duration-300"
                        [ngClass]="hasSelectionsForElection(election.id) ? 'bg-blue-600 text-white' : 'bg-gray-50 text-gray-400 group-hover:bg-blue-50 group-hover:text-blue-500'">
                        <ion-icon [name]="hasSelectionsForElection(election.id) ? 'checkmark-circle' : 'school-outline'"
                            class="text-2xl"></ion-icon>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors">{{
                            election.name }}</h3>
                        <div class="flex items-center gap-2">
                            <p *ngIf="!hasSelectionsForElection(election.id)"
                                class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">No candidate
                                selected</p>
                            <div *ngIf="hasSelectionsForElection(election.id)" class="flex items-center gap-1.5">
                                <span
                                    class="text-[10px] text-blue-600 font-bold uppercase tracking-widest">Selected:</span>
                                <span class="text-xs font-bold text-gray-700">{{
                                    getSelectionCountForElection(election.id) }} Candidates</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-gray-300 group-hover:text-blue-500 transition-all transform group-hover:translate-x-1">
                    <ion-icon name="chevron-forward-outline" class="text-xl"></ion-icon>
                </div>
            </div>

            <!-- Empty Auth State -->
            <div *ngIf="elections().length === 0" class="flex flex-col items-center justify-center py-24 text-center">
                <div class="p-8 bg-gray-100 rounded-full mb-6 text-gray-300">
                    <ion-icon name="person-outline" class="text-6xl"></ion-icon>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Unauthorized Access</h3>
                <p class="text-gray-500 text-sm max-w-xs mx-auto">
                    We couldn't find any active sessions for your token. Please log in again.
                </p>
            </div>

            <div class="pb-32"></div>
        </div>

        <!-- Step 2: Candidates Flow -->
        <div *ngIf="selectedElection()" class="animate-in fade-in slide-in-from-right-8 duration-400">
            <div (click)="clearSelection()"
                class="inline-flex items-center gap-2 text-[#0549b4] font-bold text-sm mb-6 cursor-pointer hover:bg-blue-50 px-3 py-2 rounded-xl transition-all active:scale-95">
                <ion-icon name="arrow-back"></ion-icon>
                Back to Elections
            </div>

            <div class="space-y-8 mb-32">
                <div *ngFor="let group of candidatesByPosition()">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-800">{{ group.name }}</h2>
                        <ion-badge *ngIf="getSelectedCandidateName(group.name)" color="success" mode="ios">
                            Selection Made
                        </ion-badge>
                    </div>
                    <div class="space-y-4">
                        <div *ngFor="let candidate of group.candidates">
                            <app-candidate-card [candidate]="candidate" [selected]="isCandidateSelected(candidate)"
                                (select)="selectCandidate($event)">
                            </app-candidate-card>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Bar: Cast Vote(s) -->
        <div *ngIf="selectionCount() > 0 && !selectedElection()"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#0549b4] text-white rounded-3xl shadow-2xl p-5 transition-all duration-500 animate-in slide-in-from-bottom-8">
            <div class="flex items-center justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-1 opacity-80">Ready to
                        Submit</p>
                    <p class="text-lg font-bold truncate leading-tight">
                        {{ selectionCount() }} {{ selectionCount() === 1 ? 'Selection' : 'Selections' }} Made
                    </p>
                </div>
                <button (click)="castVotes()" [disabled]="isLoading()"
                    class="flex items-center justify-center gap-2 bg-white text-[#0549b4] font-extrabold px-6 py-4 rounded-2xl transition-all shadow-xl hover:bg-blue-50 active:scale-95 disabled:opacity-50">
                    <span *ngIf="!isLoading()">Finalize Vote</span>
                    <ion-spinner *ngIf="isLoading()" name="crescent" class="w-5 h-5"></ion-spinner>
                    <ion-icon *ngIf="!isLoading()" name="arrow-forward" class="text-lg"></ion-icon>
                </button>
            </div>
        </div>

        <!-- Mini Selection Bar in Candidates View -->
        <div *ngIf="selectedElection() && getSelectionCountForElection(selectedElection()!.id) > 0"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-white border border-gray-100 rounded-3xl shadow-2xl p-4 animate-in slide-in-from-bottom-5">
            <div class="flex items-center justify-between gap-3">
                <div class="flex-1 min-w-0 bg-blue-50/50 px-4 py-3 rounded-2xl">
                    <p class="text-[9px] font-bold text-blue-400 uppercase tracking-widest mb-0.5">Current Progress:</p>
                    <p class="text-base font-bold text-gray-900 truncate">
                        {{ getSelectionCountForElection(selectedElection()!.id) }} / {{
                        selectedElection()!.positions.length }} Positions Filled
                    </p>
                </div>
                <button (click)="clearSelection()"
                    class="bg-[#0549b4] text-white font-bold px-6 py-4 rounded-2xl shadow-lg active:scale-95 transition-all">
                    Done
                </button>
            </div>
        </div>

    </div>
</ion-content>